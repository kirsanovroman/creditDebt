# Roadmap: Debt Tracker Telegram Bot

Пошаговый план разработки MVP Telegram-бота для учёта задолженностей.

## Этап 1: Подготовка и настройка проекта

- [x] Инициализация проекта (Python, структура папок)
- [x] Настройка виртуального окружения
- [x] Создание requirements.txt с зависимостями (python-telegram-bot, asyncpg, и др.)
- [x] Настройка .env файла и конфигурации
- [x] Создание базовой структуры папок (handlers/, services/, repositories/, models/, migrations/)
- [x] Инициализация git репозитория и .gitignore
- [x] Создание README.md с описанием проекта и инструкциями

## Этап 2: База данных и миграции

- [x] Настройка подключения к PostgreSQL
- [x] Создание миграции для таблицы `users` (id, tg_user_id unique, created_at)
- [x] Создание миграции для таблицы `debts` (id, debtor_user_id, creditor_user_id, principal_amount, currency, monthly_payment, due_day, status, closed_at, close_note, created_at, updated_at)
- [x] Создание миграции для таблицы `payments` (id, debt_id, amount, payment_date, deleted_at, created_at, updated_at)
- [x] Создание миграции для таблицы `invites` (id, debt_id, token UUID, expires_at, used_at, created_at)
- [x] Создание миграции для таблицы `audit_log` (id, entity_type, entity_id, action, actor_user_id, occurred_at, before JSONB, after JSONB)
- [x] Создание необходимых индексов
- [x] Настройка ограничений (CHECK для due_day [1..31], суммы > 0)
- [ ] Тестирование миграций (up/down)

## Этап 3: Модели данных и репозитории

- [x] Создание модели User (репозиторий: create_or_get_by_tg_id, get_by_id)
- [x] Создание модели Debt (репозиторий: create, get_by_id, get_by_debtor, get_by_creditor, update, check_access, close_debt)
- [x] Создание модели Payment (репозиторий: create, get_by_debt_id, get_by_id, soft_delete, calculate_balance)
- [x] Создание модели Invite (репозиторий: create, get_by_token, mark_as_used, cleanup_expired)
- [x] Создание модели AuditLog (репозиторий: create)
- [x] Реализация базового класса Repository с транзакциями
- [ ] Тестирование репозиториев (unit-тесты с mock БД)

## Этап 4: Бизнес-логика (Services)

- [x] Сервис DebtService:
  - [x] Создание долга (с проверками)
  - [x] Получение списка долгов пользователя (debtor/creditor)
  - [x] Обновление условий долга (monthly_payment, due_day) с проверкой статуса
  - [x] Закрытие долга (status=closed, closed_at, close_note)
  - [x] Проверка прав доступа (debtor/creditor)
- [x] Сервис PaymentService:
  - [x] Добавление платежа (с проверкой статуса долга)
  - [x] Удаление платежа (soft delete)
  - [x] Пересчёт остатка долга (principal_amount - сумма активных платежей)
  - [x] Валидация платежей (запрет при status=closed)
- [x] Сервис InviteService:
  - [x] Генерация invite-токена (UUID, срок 7 дней)
  - [x] Принятие приглашения (проверка токена, одноразовость)
  - [x] Очистка истекших токенов
- [x] Сервис PlannerService:
  - [x] Расчёт плана погашения (до 6 платежей)
  - [x] Определение следующей даты платежа (с учётом due_day и граничных дат 29-31)
  - [x] Обработка "добивающего" платежа (остаток <= monthly_payment)
  - [x] Обработка случаев с balance <= 0 (пустой план)
- [x] Сервис AuditService:
  - [x] Логирование create/update/delete/close операций
  - [x] Интеграция с транзакциями (атомарность)

## Этап 5: Telegram Bot Handlers

- [x] Настройка бота (получение токена, создание Application)
- [x] Handler /start - главное меню:
  - [x] Мои долги
  - [x] Создать долг
  - [x] Помощь
- [x] Handler "Мои долги":
  - [x] Список долгов пользователя (debtor и creditor)
  - [x] Inline-кнопки для каждого долга
- [x] Handler "Детали долга":
  - [x] Отображение информации о долге
  - [x] Текущий баланс
  - [x] План погашения
  - [x] Кнопки действий (зависит от прав: debtor может редактировать, creditor только читать)
- [x] Handler "Создать долг":
  - [x] Многошаговый диалог (principal_amount, currency, monthly_payment, due_day, кредитор)
  - [x] Валидация ввода
  - [x] Кнопка "Отмена"
- [x] Handler "Добавить платёж":
  - [x] Ввод суммы и даты
  - [x] Проверка прав (только debtor) и статуса долга
  - [x] Сохранение с аудитом
- [x] Handler "Удалить платёж":
  - [x] Выбор платежа
  - [x] Soft delete с аудитом
- [x] Handler "Редактировать долг":
  - [x] Изменение monthly_payment и due_day (только для активных долгов)
  - [x] Проверка прав (только debtor)
- [x] Handler "Закрыть долг":
  - [x] Подтверждение и опциональный close_note
  - [x] Проверка прав (только debtor)
- [x] Handler "Пригласить кредитора":
  - [x] Генерация invite-токена
  - [x] Отправка ссылки с токеном
- [x] Handler "Принять приглашение":
  - [x] Обработка токена из ссылки
  - [x] Связывание пользователя с долгом как creditor
- [x] Handler "Помощь" - справка по использованию
- [x] Обработка ошибок и валидации с понятными сообщениями

## Этап 6: Аудит и транзакции

- [x] Интеграция AuditService во все операции изменения данных
- [x] Обеспечение атомарности операций (изменение + audit_log в одной транзакции)
- [x] Реализация логирования create/update/delete/close для:
  - [x] Долгов (debts) - create, update, close
  - [x] Платежей (payments) - create, delete (soft)
  - [x] Приглашений (invites) - create, update (mark_as_used)
- [ ] Тестирование транзакций (rollback при ошибках)

## Этап 7: Безопасность и валидация

- [x] Проверка прав доступа в handlers (перед любой операцией с debt_id)
- [x] Дублирование проверки прав в сервисах (защитный слой)
- [x] Валидация всех входных данных (суммы > 0, due_day [1..31], и т.д.)
- [x] Проверка статуса долга перед изменениями (запрет при status=closed)
- [x] Защита от логирования секретов (BOT_TOKEN, креды БД)
- [x] Валидация одноразовости invite-токенов
- [x] Проверка срока действия invite-токенов

## Этап 8: Тестирование

- [x] Создание структуры тестов (pytest, pytest-asyncio, pytest-mock)
- [x] Unit-тесты для PlannerService:
  - [x] due_day=31 в феврале (обычный и високосный год)
  - [x] due_day=29/30 в разных месяцах
  - [x] today == due_date
  - [x] today > due_date
  - [x] Генерация не более 6 платежей
  - [x] "Добивающий" платёж (остаток <= monthly_payment)
- [ ] Unit-тесты для расчёта balance (с учётом soft-deleted платежей) - требует тестовой БД
- [ ] Unit-тесты для сервисов (независимо от Telegram) - требует тестовой БД или моки
- [ ] Тесты для проверки прав доступа - требует тестовой БД
- [ ] Тесты для валидации бизнес-правил (запрет изменений при status=closed) - требует тестовой БД
- [ ] Тесты для транзакций и аудита - требует тестовой БД
- [ ] Интеграционные тесты с тестовой БД - требует настройки тестовой БД

## Этап 9: Документация и финализация

- [x] Обновление README.md:
  - [x] Описание проекта
  - [x] Установка и настройка
  - [x] Переменные окружения (.env)
  - [x] Инструкции по запуску
  - [x] Структура проекта (обновлена с подробным описанием)
  - [x] Добавлена секция "Тестирование"
- [x] Добавление docstrings к основным функциям и классам (присутствуют во всех основных модулях)
- [x] Комментарии для сложных участков кода (присутствуют в ключевых местах)
- [x] Создание .env.example файла (уже существует)
- [x] Проверка соответствия type hints во всём проекте (type hints присутствуют везде)

## Этап 10: Подготовка к деплою

- [x] Настройка логирования (структурированные логи, уменьшён уровень для библиотек)
- [x] Обработка ошибок на уровне приложения (улучшена с дополнительным логированием)
- [x] Настройка graceful shutdown (обработка SIGINT/SIGTERM, улучшен post_shutdown)
- [x] Проверка производительности (оптимизация запросов к БД - пул подключений, индексы присутствуют)
- [ ] Финальное тестирование всех сценариев использования (требует ручного тестирования)
- [x] Подготовка инструкций для деплоя (создан DEPLOY.md с инструкциями для systemd, supervisor, Docker)

---

## Приоритеты разработки

1. **Критично**: Безопасность и проверка прав доступа (Этап 7)
2. **Критично**: Транзакции и аудит (Этап 6)
3. **Высокий**: Базовая функциональность (Этапы 3-5)
4. **Средний**: Тестирование и документация (Этапы 8-9)

## Заметки

- Все операции должны быть асинхронными (async/await)
- Handlers должны быть тонкими, бизнес-логика в services/
- Репозитории только для работы с БД
- Все секреты через env/config
- Навигация только через inline-кнопки

