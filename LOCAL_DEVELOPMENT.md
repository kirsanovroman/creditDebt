# Локальная разработка и тестирование

## Проблема

Один и тот же токен Telegram бота нельзя использовать одновременно на сервере и локально. Telegram не позволяет одному боту работать из двух мест одновременно.

## Решение: Тестовый бот для локальной разработки

### Быстрый старт

```bash
# Запустите скрипт настройки
./setup_local_dev.sh

# Или вручную:
cp .env .env.local
# Затем отредактируйте .env.local и укажите токен тестового бота
```

### Шаг 1: Создайте тестового бота

1. Откройте Telegram и найдите [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям:
   - Введите имя бота (например: `Debt Tracker Test Bot`)
   - Введите username бота (например: `debt_tracker_test_bot`)
   - **Важно:** username должен быть уникальным и заканчиваться на `bot`
4. BotFather выдаст вам токен для тестового бота (например: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)
5. **Сохраните токен** - он понадобится в следующем шаге

### Шаг 2: Настройте локальное окружение

1. Файл `.env.local` уже создан (на основе `.env.example`)

2. Откройте `.env.local` в редакторе:
```bash
nano .env.local
# или
code .env.local
```

3. Укажите токен тестового бота и настройки БД:
```env
# Telegram Bot Configuration (тестовый бот для локальной разработки)
BOT_TOKEN=your_test_bot_token_here

# Database Configuration (локальная БД)
DB_HOST=localhost
DB_PORT=5432
DB_NAME=debt_bot
DB_USER=postgres
DB_PASSWORD=your_local_db_password

# Application Configuration
INVITE_TOKEN_EXPIRY_DAYS=7
```

**Важно:**
- Файл `.env.local` уже добавлен в `.gitignore`, поэтому он не попадёт в репозиторий
- `.env.local` имеет приоритет над `.env` - его значения перезаписывают значения из `.env`
- На сервере используйте `.env` с production токеном
- Локально используйте `.env.local` с тестовым токеном

### Шаг 3: Запустите бота локально

```bash
# Активируйте виртуальное окружение
source venv/bin/activate

# Запустите бота
python3 main.py
```

Теперь бот будет использовать токен из `.env.local` и не будет конфликтовать с ботом на сервере.

---

## Альтернативный вариант: Остановка бота на сервере

Если вы не хотите создавать тестового бота, можно временно останавливать бота на сервере перед локальным запуском:

### На сервере:

```bash
# Остановите бота
sudo systemctl stop debtbot

# Проверьте статус
sudo systemctl status debtbot
```

### Локально:

```bash
# Запустите бота
source venv/bin/activate
python3 main.py
```

### После тестирования:

```bash
# На сервере - запустите бота обратно
sudo systemctl start debtbot
```

**Недостаток:** Бот на сервере будет недоступен во время локального тестирования.

---

## Рекомендация

**Используйте тестового бота** - это лучший вариант для разработки:
- ✅ Бот на сервере продолжает работать
- ✅ Можно тестировать локально в любое время
- ✅ Не нужно останавливать production бота
- ✅ Можно экспериментировать без риска для production

---

## Проверка конфигурации

Чтобы убедиться, что используется правильный токен, можно добавить временный лог в `main.py`:

```python
logger.info(f"Bot token starts with: {config.BOT_TOKEN[:10]}...")
```

Или проверить, какой файл загружается:

```python
import os
print(f"BOT_TOKEN from env: {os.getenv('BOT_TOKEN')[:10]}...")
```

---

## Структура файлов

```
debt_bot/
├── .env              # Production конфигурация (на сервере)
├── .env.local        # Локальная конфигурация (только локально, в .gitignore)
├── .env.example       # Пример конфигурации
└── config.py          # Загружает .env, затем .env.local (если существует)
```

---

**Готово!** Теперь вы можете разрабатывать и тестировать локально, не мешая production боту на сервере.
